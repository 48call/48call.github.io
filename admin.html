<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <script src="https://kit.fontawesome.com/94a9082cc4.js" crossorigin="anonymous">//æŠ–éŸ³,threads icon</script>
    <script src="https://cdn.staticfile.net/translate.js/3.1.7/translate.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://64071181.github.io/mokJsapi/a.js">//çªçªä¿®æ”¹</script>


  <title>48call Admin</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f5f5f5; }
    input[type="date"] { padding: 4px; }
    button { padding: 6px 10px; cursor: pointer; }
    .active { color: green; font-weight: bold; }
    .inactive { color: red; font-weight: bold; }
    #adminPanel { display: none; }
  </style>

  <!-- Firebase compatï¼ˆä½ åŸæœ¬ç”¨ firebase.auth()ï¼Œé€™çµ„æœ€ç©©å®šï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>

<h2>48call ç®¡ç†å¾Œè‡º</h2>

<div id="authBox">
  <button onclick="login()">ç®¡ç†å“¡ç™»å…¥</button>
</div>

<div id="adminPanel">
  <p>
    ğŸ‘¤ ç›®å‰ç™»å…¥ç®¡ç†å“¡ï¼š<b id="adminEmail"></b>
    <button onclick="logout()">ç™»å‡º</button>
  </p>

  <table>
    <thead>
      <tr>
        <th>ç”¨æˆ¶å§“å</th>
        <th>è¯çµ¡äºº Email</th>
        <th>ä¸Šæ¬¡æ‰“å¡</th>
        <th>åˆ°æœŸæ—¥</th>
        <th>ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="userTable"></tbody>
  </table>


    <div id="ContactAKI" class="ContactAKI"><!-- JS _é¡¯ç¤ºè¯è« --></div>
    <div class="copyright">
        <p class="mokJsApi_copyright">ç‰ˆæ¬Š</p>
    </div>
    <div class="scroll-top" id="scrollTop" style="background: #ccc;bottom: 40%;" onclick="scrollToTop()">â†‘</div>


</div>

<script>

/*
          :::        :::    :::       :::::::::::
       :+: :+:      :+:   :+:            :+:
     +:+   +:+     +:+  +:+             +:+
   +#++:++#++:    +#++:++              +#+
  +#+     +#+    +#+  +#+             +#+
 #+#     #+#    #+#   #+#            #+#
###     ###    ###    ###       ###########
*/

        // å‹•æ…‹å…§å®¹è‡ªå‹•ç¿»è­¯å°å‡½æ•¸
        function callTranslate() {
          if (window.translate && typeof translate.execute === 'function') {
            translate.execute();
          }
        }
        translate.service.use('client.edge'); //è¨­ç½®æ©Ÿå™¨ç¿»è­¯æœå‹™é€šé“ï¼Œç›´æ¥å®¢æˆ¶ç«¯æœ¬èº«ï¼Œä¸ä¾è³´æœå‹™ç«¯ ã€‚ç›¸é—œèªªæ˜åƒè€ƒ http://translate.zvo.cn/43086.html
        translate.execute();//é€²è¡Œç¿»è­¯ 
        function Start() {
            // é¡¯ç¤ºè¯è«
            //[mail,whatsapp,WechatQR,instagram,line,facebook,telegram,github,å°ç´…æ›¸,æŠ–éŸ³,threads,youtube]
            const è¯è« = ['moksurky@gmail.com','https://wa.me/85264071181/','https://i.meee.com.tw/4xTmYL9.jpeg','','','','','','','','',''
            ];
            _é¡¯ç¤ºè¯è«(è¯è«);
        }
        çªçªä¿®æ”¹('https://64071181.github.io/')

/* =======================
   Firebase åˆå§‹åŒ–
======================= */
const firebaseConfig = {
  apiKey: "AIzaSyA8eWS7fwj5eyzK21YlFRov1n4oIVmmkHY",
  authDomain: "call-3ba0f.firebaseapp.com",
  projectId: "call-3ba0f",
  storageBucket: "call-3ba0f.firebasestorage.app",
  messagingSenderId: "157503642050",
  appId: "1:157503642050:web:8687d0340afa95cc85de5b",
  measurementId: "G-Y6BEGYPW7R"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

/* =======================
   å…¨åŸŸè®Šæ•¸
======================= */
let idToken = null;
const API = "https://us-central1-call-3ba0f.cloudfunctions.net";

/* =======================
   ç™»å…¥
======================= */
async function login() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await auth.signInWithPopup(provider);

    const user = result.user;
    idToken = await user.getIdToken(true);

    // å–å¾— claims
    const tokenResult = await user.getIdTokenResult(true);
    console.log("æ˜¯å¦ç‚ºç®¡ç†å“¡:", tokenResult.claims.admin);

    if (!tokenResult.claims.admin) {
      alert("âŒ æ­¤å¸³è™Ÿä¸æ˜¯ç®¡ç†å“¡");
      await auth.signOut();
      return;
    }

    // é¡¯ç¤ºå¾Œå°
    document.getElementById("authBox").style.display = "none";
    document.getElementById("adminPanel").style.display = "block";
    document.getElementById("adminEmail").innerText = user.email;

    // è¼‰å…¥è³‡æ–™
    loadUsers();
  } catch (err) {
    console.error(err);
    alert("ç™»å…¥å¤±æ•—");
  }
}

/* =======================
   ç™»å‡º
======================= */
async function logout() {
  await auth.signOut();
  idToken = null;
  document.getElementById("authBox").style.display = "block";
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("userTable").innerHTML = "";
}

/* =======================
   è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
======================= */
async function loadUsers() {
  const res = await fetch(`${API}/adminList`, {
    headers: { "Authorization": "Bearer " + idToken }
  });

  const data = await res.json();
  if (!data.success) {
    alert("è®€å–å¤±æ•—");
    return;
  }

  const tbody = document.getElementById("userTable");
  tbody.innerHTML = "";

  data.users.forEach(u => {
    // ===== æ–°å¢è°ƒè¯•ï¼šæ‰“å°çœŸå®æ‹¿åˆ°çš„æ—¶é—´å€¼ =====
    //console.log("ç”¨æˆ·ï¼š", u.name, "last_checkinåŸå§‹å€¼ï¼š", u.last_checkin, "ç±»å‹ï¼š", typeof u.last_checkin);
    // ==========================================

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.name || "-"}</td>
      <td>${u.contact_email || "-"}</td>
      <td>${formatTimestamp(u.last_checkin)}</td>
      <td>
        <input type="date" value="${u.expiry_date || ""}" 
               onchange="setExpiry('${u.userId}', this.value)">
      </td>
      <td class="${u.is_active ? 'active' : 'inactive'}">
        ${u.is_active ? "å•Ÿç”¨ä¸­" : "å·²åœç”¨"}
      </td>
      <td>
        <button onclick="toggleUser('${u.userId}', ${!u.is_active})">
          ${u.is_active ? "åœç”¨" : "å•Ÿç”¨"}
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}






/* =======================
   å•Ÿç”¨ / åœç”¨
======================= */
async function toggleUser(userId, status) {
  await fetch(`${API}/adminToggle`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + idToken
    },
    body: JSON.stringify({ userId, is_active: status })
  });
  loadUsers();
}

/* =======================
   è¨­å®šåˆ°æœŸæ—¥
======================= */
async function setExpiry(userId, date) {
  await fetch(`${API}/adminSetExpiry`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + idToken
    },
    body: JSON.stringify({ userId, expiry_date: date })
  });
}






/* =======================
   æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸ï¼ˆä¿®å¤ç‰ˆï¼‰
======================= */
function formatTimestamp(ts) {
  if (!ts) return "å°šæœªæ‰“å¡";

  // å…¼å®¹ Firestore Timestamp ä¸¤ç§å†™æ³•ï¼šseconds / _seconds
  const seconds = ts.seconds || ts._seconds;
  if (seconds) {
    const date = new Date(seconds * 1000);
    // è¡¥å……çº³ç§’çº§ç²¾åº¦ï¼ˆå¯é€‰ï¼Œä¸å½±å“æ˜¾ç¤ºï¼‰
    date.setMilliseconds(ts.nanoseconds || ts._nanoseconds || 0);
    return date.toLocaleString("zh-HK");
  }

  // å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå¦‚å¸¦æ—¶åŒºçš„æ–‡æœ¬ï¼‰
  if (typeof ts === "string") return ts;

  return "å°šæœªæ‰“å¡";
}



</script>

</body>
</html>
